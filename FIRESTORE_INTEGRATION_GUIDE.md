# Firestore Database Integration Guide for ReTurnHub

This guide explains the Firestore database structure and collections used in the ReTurnHub app.

## Table of Contents
1. [Database Structure](#database-structure)
2. [Collections Overview](#collections-overview)
3. [Collection Schemas](#collection-schemas)
4. [Security Rules](#security-rules)
5. [Indexes](#indexes)
6. [Usage Examples](#usage-examples)

---

## Database Structure

ReTurnHub uses the following Firestore collections:

### Main Collections
- **users** - User profiles and authentication data
- **posts** - User posts (lost/found items)
- **comments** - Comments on posts
- **likes** - Post likes/reactions
- **chats** - Chat conversations between users
- **messages** - Messages within chats (subcollection)

---

## Collections Overview

### 1. **users** Collection
Stores user profile information.

**Document ID**: User's Firebase Auth UID

**Fields**:
```typescript
{
  id: string,              // User ID (same as document ID)
  name: string,           // User's display name
  email: string,           // User's email
  profileImage: string?,   // URL to profile image
  role: string,           // "user" or "admin"
  createdAt: Timestamp    // Account creation date
}
```

**Example Document**:
```json
{
  "id": "abc123",
  "name": "John Doe",
  "email": "john@example.com",
  "profileImage": "https://storage.googleapis.com/...",
  "role": "user",
  "createdAt": "2024-01-15T10:30:00Z"
}
```

---

### 2. **posts** Collection
Stores user posts (lost/found items).

**Document ID**: Auto-generated by Firestore

**Fields**:
```typescript
{
  id: string,              // Post ID (same as document ID)
  userId: string,          // ID of the user who created the post
  userName: string,        // User's display name (denormalized for quick access)
  userAvatar: string?,     // User's avatar URL (denormalized)
  content: string,         // Post content/description
  imageUrl: string?,       // URL to post image
  createdAt: Timestamp,    // Post creation date
  updatedAt: Timestamp,    // Last update date
  likesCount: number,      // Number of likes (denormalized for performance)
  commentsCount: number,   // Number of comments (denormalized)
  type: string?,           // "lost" or "found" (optional)
  location: string?,       // Location where item was lost/found
  contact: string?         // Contact information
}
```

**Example Document**:
```json
{
  "id": "post123",
  "userId": "abc123",
  "userName": "John Doe",
  "userAvatar": "https://storage.googleapis.com/...",
  "content": "Lost my keys near the park",
  "imageUrl": "https://storage.googleapis.com/...",
  "createdAt": "2024-01-20T14:30:00Z",
  "updatedAt": "2024-01-20T14:30:00Z",
  "likesCount": 5,
  "commentsCount": 2,
  "type": "lost",
  "location": "Central Park",
  "contact": "john@example.com"
}
```

---

### 3. **comments** Collection
Stores comments on posts.

**Document ID**: Auto-generated by Firestore

**Fields**:
```typescript
{
  id: string,              // Comment ID
  postId: string,          // ID of the post being commented on
  userId: string,          // ID of the user who commented
  userName: string,        // User's display name (denormalized)
  userAvatar: string?,     // User's avatar URL (denormalized)
  content: string,         // Comment text
  createdAt: Timestamp     // Comment creation date
}
```

**Example Document**:
```json
{
  "id": "comment456",
  "postId": "post123",
  "userId": "xyz789",
  "userName": "Jane Smith",
  "userAvatar": "https://storage.googleapis.com/...",
  "content": "I think I saw something similar!",
  "createdAt": "2024-01-20T15:00:00Z"
}
```

**Query Pattern**: Query by `postId` to get all comments for a post, ordered by `createdAt`.

---

### 4. **likes** Collection
Stores post likes/reactions.

**Document ID**: Auto-generated by Firestore (or composite: `{postId}_{userId}`)

**Fields**:
```typescript
{
  id: string,              // Like ID
  postId: string,          // ID of the post being liked
  userId: string,          // ID of the user who liked
  createdAt: Timestamp     // Like creation date
}
```

**Example Document**:
```json
{
  "id": "like789",
  "postId": "post123",
  "userId": "xyz789",
  "createdAt": "2024-01-20T16:00:00Z"
}
```

**Query Pattern**: 
- Query by `postId` to get all likes for a post
- Query by `postId` and `userId` to check if a user has liked a post

**Note**: Consider using a composite document ID like `{postId}_{userId}` to prevent duplicate likes.

---

### 5. **chats** Collection
Stores chat conversations between users.

**Document ID**: Auto-generated by Firestore (or composite: sorted user IDs)

**Fields**:
```typescript
{
  id: string,              // Chat ID
  participants: string[],  // Array of user IDs in the chat
  participantNames: string[], // Array of user names (denormalized)
  participantAvatars: string[], // Array of user avatars (denormalized)
  lastMessage: string?,    // Last message content (denormalized)
  lastMessageTime: Timestamp?, // Last message timestamp
  lastMessageSenderId: string?, // ID of last message sender
  createdAt: Timestamp,    // Chat creation date
  updatedAt: Timestamp     // Last update date
}
```

**Example Document**:
```json
{
  "id": "chat123",
  "participants": ["abc123", "xyz789"],
  "participantNames": ["John Doe", "Jane Smith"],
  "participantAvatars": ["https://...", "https://..."],
  "lastMessage": "Thanks for the help!",
  "lastMessageTime": "2024-01-20T17:00:00Z",
  "lastMessageSenderId": "xyz789",
  "createdAt": "2024-01-20T10:00:00Z",
  "updatedAt": "2024-01-20T17:00:00Z"
}
```

**Subcollection**: `messages` - Contains messages for this chat

**Query Pattern**: Query by `participants` array-contains to find chats for a user.

---

### 6. **messages** Subcollection
Stores messages within a chat (subcollection of `chats`).

**Path**: `chats/{chatId}/messages/{messageId}`

**Document ID**: Auto-generated by Firestore

**Fields**:
```typescript
{
  id: string,              // Message ID
  senderId: string,        // ID of the message sender
  senderName: string,      // Sender's display name (denormalized)
  senderAvatar: string?,   // Sender's avatar URL (denormalized)
  content: string,         // Message text
  timestamp: Timestamp     // Message timestamp
}
```

**Example Document**:
```json
{
  "id": "msg456",
  "senderId": "abc123",
  "senderName": "John Doe",
  "senderAvatar": "https://storage.googleapis.com/...",
  "content": "Hello, I found your item!",
  "timestamp": "2024-01-20T17:00:00Z"
}
```

**Query Pattern**: Query by `timestamp` to get messages in chronological order.

---

## Security Rules

### Recommended Firestore Security Rules

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is the owner
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Users collection
    match /users/{userId} {
      // Users can read any user profile
      allow read: if isAuthenticated();
      // Users can only update their own profile
      allow create, update: if isOwner(userId);
      // Only admins can delete users
      allow delete: if isAdmin();
    }
    
    // Posts collection
    match /posts/{postId} {
      // Anyone authenticated can read posts
      allow read: if isAuthenticated();
      // Users can create posts
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      // Users can update/delete their own posts, admins can delete any
      allow update: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || isAdmin());
      allow delete: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // Comments collection
    match /comments/{commentId} {
      // Anyone authenticated can read comments
      allow read: if isAuthenticated();
      // Users can create comments
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      // Users can update/delete their own comments, admins can delete any
      allow update: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || isAdmin());
      allow delete: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // Likes collection
    match /likes/{likeId} {
      // Anyone authenticated can read likes
      allow read: if isAuthenticated();
      // Users can create likes
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      // Users can delete their own likes
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
    }
    
    // Chats collection
    match /chats/{chatId} {
      // Users can only read chats they are part of
      allow read: if isAuthenticated() && 
                     request.auth.uid in resource.data.participants;
      // Users can create chats
      allow create: if isAuthenticated() && 
                       request.auth.uid in request.resource.data.participants;
      // Users can update chats they are part of
      allow update: if isAuthenticated() && 
                       request.auth.uid in resource.data.participants;
      
      // Messages subcollection
      match /messages/{messageId} {
        // Users can read messages in chats they are part of
        allow read: if isAuthenticated() && 
                       request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        // Users can create messages in chats they are part of
        allow create: if isAuthenticated() && 
                         request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants &&
                         request.resource.data.senderId == request.auth.uid;
        // Users can update/delete their own messages
        allow update, delete: if isAuthenticated() && 
                                 resource.data.senderId == request.auth.uid;
      }
    }
  }
}
```

---

## Indexes

Firestore may require composite indexes for certain queries. Create these indexes in the Firebase Console:

### Required Indexes

1. **Comments by Post and Date**
   - Collection: `comments`
   - Fields: `postId` (Ascending), `createdAt` (Descending)

2. **Likes by Post**
   - Collection: `likes`
   - Fields: `postId` (Ascending), `createdAt` (Descending)

3. **Likes by User and Post** (to check if user liked a post)
   - Collection: `likes`
   - Fields: `userId` (Ascending), `postId` (Ascending)

4. **Chats by Participant**
   - Collection: `chats`
   - Fields: `participants` (Array), `updatedAt` (Descending)

5. **Messages by Timestamp**
   - Collection: `chats/{chatId}/messages`
   - Fields: `timestamp` (Ascending)

6. **Posts by Date** (optional, for sorting)
   - Collection: `posts`
   - Fields: `createdAt` (Descending)

### How to Create Indexes

1. Go to Firebase Console → Firestore Database → Indexes
2. Click "Create Index"
3. Select the collection
4. Add the fields in the order specified
5. Set the order (Ascending/Descending)
6. Click "Create"

Alternatively, Firestore will suggest creating indexes when you run queries that require them.

---

## Usage Examples

### Creating a Post
```dart
final postService = PostService();
final post = Post(
  id: '', // Will be auto-generated
  userId: currentUserId,
  userName: currentUserName,
  userAvatar: currentUserAvatar,
  content: 'Lost my keys',
  imageUrl: imageUrl,
  createdAt: DateTime.now(),
);

await postService.createPost(post);
```

### Getting Posts
```dart
final postService = PostService();
// Get all posts, ordered by creation date
final posts = await postService.getPosts();
// Or listen to real-time updates
postService.getPostsStream().listen((posts) {
  // Update UI
});
```

### Adding a Comment
```dart
final commentService = CommentService();
await commentService.addComment(
  postId: 'post123',
  userId: currentUserId,
  userName: currentUserName,
  userAvatar: currentUserAvatar,
  content: 'I can help!',
);
```

### Liking a Post
```dart
final likeService = LikeService();
await likeService.toggleLike(
  postId: 'post123',
  userId: currentUserId,
);
```

### Sending a Message
```dart
final chatService = ChatService();
await chatService.sendMessage(
  chatId: 'chat123',
  senderId: currentUserId,
  senderName: currentUserName,
  senderAvatar: currentUserAvatar,
  content: 'Hello!',
);
```

---

## Best Practices

1. **Denormalization**: Store frequently accessed data (like user names and avatars) directly in posts/comments to avoid multiple reads.

2. **Counters**: Use denormalized counters (`likesCount`, `commentsCount`) for better performance. Update them using Firestore transactions.

3. **Pagination**: Use `limit()` and `startAfter()` for pagination to avoid loading too much data at once.

4. **Real-time Updates**: Use `snapshots()` for real-time updates in chat and post feeds.

5. **Batch Operations**: Use batch writes when updating multiple documents (e.g., updating like count and creating like document).

6. **Error Handling**: Always handle Firestore errors gracefully and provide user feedback.

7. **Offline Support**: Firestore provides offline persistence by default. Test your app's offline behavior.

---

## Next Steps

1. ✅ Review this guide
2. ✅ Set up Firestore Security Rules in Firebase Console
3. ✅ Create required indexes
4. ✅ Update your services to use Firestore (see service files)
5. ✅ Test all CRUD operations
6. ✅ Test security rules
7. ✅ Monitor Firestore usage in Firebase Console

---

**Need Help?**
- [Firestore Documentation](https://firebase.google.com/docs/firestore)
- [FlutterFire Firestore Guide](https://firebase.flutter.dev/docs/firestore/usage/)
- [Firestore Security Rules](https://firebase.google.com/docs/firestore/security/get-started)

